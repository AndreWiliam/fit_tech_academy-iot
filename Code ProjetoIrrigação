#include <DHT.h>
#include <WiFi.h>
#include <PubSubClient.h>

#define DHTPIN 32     // Pino onde o sensor está conectado (GPIO4)
#define DHTTYPE DHT22 // Tipo do sensor (DHT11 ou DHT22)

#define ledR 13 // Pino do LED vermelho (GPIO16)
#define ledG 14 // Pino do LED verde (GPIO17)
//#define vSolenoide 15 // Pino da válvula solenoide

///########### configuração do wifi
#define WIFI_SSID "Wokwi-GUEST"
#define WIFI_PASSWORD ""
// Defining the WiFi channel speeds up the connection:
#define WIFI_CHANNEL 6
int status = WL_IDLE_STATUS; // the Wifi radio's status

///########## configuração do MQTT
const char *mqtt_server = "test.mosquitto.org"; // MQTT broker
char *my_topic_SUB = "FIT/SUB";                 // the chosen topic
char *my_topic_PUB = "FIT/PUB";                 // the chosen topic

/////##### configuração do wifi e MQTT
WiFiClient espClient;
PubSubClient client(espClient);
DHT dht(DHTPIN, DHTTYPE);

void conectawifi()
{
    WiFi.begin(WIFI_SSID, WIFI_PASSWORD, WIFI_CHANNEL);
    Serial.print("Conectando ao WiFi ");
    Serial.print(WIFI_SSID);
    // Wait for connection
    while (WiFi.status() != WL_CONNECTED)
    {
        delay(100);
        Serial.print(".");
    }
    Serial.println(" Conectado!");

    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());
}

// Process incoming MQTT message and control the servo motor
void callback(char *topic, byte *payload, unsigned int length)
{
    String string;
    Serial.print("Chegou a mensagem [");
    Serial.print(topic);
    Serial.print("] ");
    for (int i = 0; i < length; i++)
    {
        string += ((char)payload[i]);
    }
    Serial.print(string);
}

// Attempt to reconnect to the MQTT broker if the connection is lost
void reconnect()
{
    while (!client.connected())
    {
        Serial.print("Tentando conectar ao MQTT ...");
        if (client.connect("ESPClient"))
        {
            Serial.println("Conectado");
            client.subscribe(my_topic_SUB);
        }
        else
        {
            Serial.print("falhou, rc=");
            Serial.print(client.state());
            Serial.println(" Tente novamente em 5 segundos");
        }
    }
}

void setup()
{
    Serial.begin(115200);
    pinMode(ledR, OUTPUT);
    pinMode(ledG, OUTPUT);
    //pinMode(vSolenoide, OUTPUT);
    dht.begin();
    conectawifi();
    client.setServer(mqtt_server, 1883);
    client.setCallback(callback);
}

void loop()
{
    if (!client.connected())
    {
        reconnect();
    }
    client.loop();

    float umidade = dht.readHumidity();

    if (isnan(umidade))
    {
        Serial.println("Falha ao ler a umidade!");
        return;
    }

    if (umidade < 50.0)
    {
        digitalWrite(ledR, HIGH);    // Liga o LED Vermelho
        digitalWrite(ledG, LOW);     // Desliga o LED Verde
        //digitalWrite(vSolenoide, HIGH); // Ativa a válvula solenoide
        client.publish("umidade", "Umidade Baixa =( REGANDO..."); // Publica a umidade no tópico "umidade"
        delay(10000);                // Mantém a válvula solenoide ativa por 10 segundos
        //digitalWrite(vSolenoide, LOW); // Desativa a válvula solenoide
        digitalWrite(ledR, LOW);     // Desliga o LED Vermelho
        delay(2000);
    }
    else if (umidade >= 51.0)
    {
        digitalWrite(ledG, HIGH);    // Liga o LED Verde
        digitalWrite(ledR, LOW);     // Desliga o LED Vermelho
        //digitalWrite(vSolenoide, LOW); // Mantém a válvula solenoide desativada
        client.publish("umidade", "Umidade Alta =)"); // Publica a umidade no tópico "umidade"
    }
    else
    {
        digitalWrite(ledG, LOW);     // Desliga o LED Verde
        digitalWrite(ledR, LOW);     // Desliga o LED Vermelho
        //digitalWrite(vSolenoide, LOW); // Mantém a válvula solenoide desativada
        client.publish("umidade", "Normal"); // Publica a umidade no tópico "umidade"
    }

    delay(5000); // Aguarda 5 segundos antes de ler o sensor novamente
}
